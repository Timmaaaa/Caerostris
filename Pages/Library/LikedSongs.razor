@page "/library"


@inject SpotifyService Spotify


@if (tracks is null)
{
    <HeightMeasurementProvider OnMeasurementTaken=OnHeightMeasured Fluid>

        <CenteredLoadingIndicator @ref=loadingIndicator LoadingWhat="tracks" ShowProgress/>

    </HeightMeasurementProvider>
}
else
{
    <div class="d-flex flex-column justify-content-between align-items-stretch py-4 h-100">
        <div class="px-3 library-controls">
            Show:
            <BoundInlineCheckbox Label="filter row" @bind-Checked=@showFilterRow />
            <BoundInlineCheckbox Label="explicit" @bind-Checked=@showExplicitColumn />
            <BoundInlineCheckbox Label="popularity" @bind-Checked=@showPopularityColumn />
        </div>
        <div>
            <SavedTrackDataGrid Height=@datagridHeight 
                                Tracks=@tracks
                                ShowFilterRow=@showFilterRow
                                ShowExplicitColumn=@showExplicitColumn
                                ShowPopularityColumn=@showPopularityColumn
                                ShowAddedAtColumn />
        </div>
    </div>
}


@code
{
    private CenteredLoadingIndicator loadingIndicator;

    private IQueryable<SavedTrack>? tracks;

    private int datagridHeight = 550;

    private bool
        showFilterRow = true,
        showExplicitColumn = true,
        showPopularityColumn = false;


    protected async override Task OnInitializedAsync()
    {
        if (await Spotify.AuthGranted())
            tracks = (await Spotify.GetSavedTracks()).AsQueryable();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            Spotify.LibraryLoadingProgress += loadingIndicator.Update;
        }
    }

    private void OnHeightMeasured(int height)
    {
        /// If an explicit height is not passed to the DxDataGrid, it will default to a ~200px scrolling area instead of filling its container
        datagridHeight = Math.Max(height - 250, 100);
    }
}
